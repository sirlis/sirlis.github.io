---
title: è®¡ç®—æœºè§†è§‰ï¼ˆYOLO V5ï¼‰
date: 2021-06-08 09:08:49 +0800
categories: [Academic, Knowledge]
tags: [deeplearning]
math: true
---

æœ¬æ–‡ä»‹ç»äº†è®¡ç®—æœºè§†è§‰ä¸­å•é˜¶æ®µç›®æ ‡æ£€æµ‹é—®é¢˜çš„ä¸€ä¸ªæœ€æ–°å®ç°ï¼Œå³ YOLO V5ã€‚

<!--more-->

 ---
 
- [1. ç½‘ç»œç»“æ„](#1-ç½‘ç»œç»“æ„)
  - [1.1. parameters](#11-parameters)
  - [1.2. backnone](#12-backnone)
    - [1.2.1. Focus](#121-focus)
    - [1.2.2. Conv](#122-conv)
    - [1.2.3. BottleneckCSP](#123-bottleneckcsp)
  - [1.3. head](#13-head)
- [2. è®­ç»ƒ](#2-è®­ç»ƒ)
  - [2.1. å‡†å¤‡æ ‡ç­¾](#21-å‡†å¤‡æ ‡ç­¾)
  - [2.2. æ•°æ®å­˜æ”¾ä½ç½®](#22-æ•°æ®å­˜æ”¾ä½ç½®)
  - [2.3. å‡†å¤‡æ¨¡å‹](#23-å‡†å¤‡æ¨¡å‹)
  - [2.4. è¿›è¡Œè®­ç»ƒ](#24-è¿›è¡Œè®­ç»ƒ)
- [3. æµ‹è¯•](#3-æµ‹è¯•)
  - [3.1. è‡ªå®šä¹‰æ£€æµ‹](#31-è‡ªå®šä¹‰æ£€æµ‹)
  - [3.2. æ£€æµ‹å‚æ•°](#32-æ£€æµ‹å‚æ•°)
- [å…¶å®ƒ](#å…¶å®ƒ)
  - [3.3. Citation](#33-citation)

# 1. ç½‘ç»œç»“æ„

> https://www.bilibili.com/video/BV18K411n7rc

yolov5 æ˜¯ä½¿ç”¨ `xxxx.yaml` é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡`./models/yolo.py`è§£ææ–‡ä»¶åŠ äº†ä¸€ä¸ªè¾“å…¥æ„æˆçš„ç½‘ç»œæ¨¡å—ã€‚ä¸configè®¾ç½®çš„ç½‘ç»œä¸åŒï¼Œä¸éœ€è¦è¿›è¡Œå åŠ ï¼Œåªéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å¯¹numberè¿›è¡Œä¿®æ”¹å³å¯ã€‚

ä»¥ yolov5s.yaml ä¸ºä¾‹ï¼š

```yaml
# parameters
nc: 80  # number of classes
depth_multiple: 0.33  # model depth multiple
width_multiple: 0.50  # layer channel multiple

# anchors
anchors:
  - [10,13, 16,30, 33,23]  # P3/8
  - [30,61, 62,45, 59,119]  # P4/16
  - [116,90, 156,198, 373,326]  # P5/32

# YOLOv5 backbone
backbone:
  # [from, number, module, args]
  [[-1, 1, Focus, [64, 3]],  # 0-P1/2
   [-1, 1, Conv, [128, 3, 2]],  # 1-P2/4
   [-1, 3, C3, [128]],
   [-1, 1, Conv, [256, 3, 2]],  # 3-P3/8
   [-1, 9, C3, [256]],
   [-1, 1, Conv, [512, 3, 2]],  # 5-P4/16
   [-1, 9, C3, [512]],
   [-1, 1, Conv, [1024, 3, 2]],  # 7-P5/32
   [-1, 1, SPP, [1024, [5, 9, 13]]],
   [-1, 3, C3, [1024, False]],  # 9
  ]

# YOLOv5 head
head:
  [[-1, 1, Conv, [512, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 6], 1, Concat, [1]],  # cat backbone P4
   [-1, 3, C3, [512, False]],  # 13

   [-1, 1, Conv, [256, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 4], 1, Concat, [1]],  # cat backbone P3
   [-1, 3, C3, [256, False]],  # 17 (P3/8-small)

   [-1, 1, Conv, [256, 3, 2]],
   [[-1, 14], 1, Concat, [1]],  # cat head P4
   [-1, 3, C3, [512, False]],  # 20 (P4/16-medium)

   [-1, 1, Conv, [512, 3, 2]],
   [[-1, 10], 1, Concat, [1]],  # cat head P5
   [-1, 3, C3, [1024, False]],  # 23 (P5/32-large)

   [[17, 20, 23], 1, Detect, [nc, anchors]],  # Detect(P3, P4, P5)
  ]
```
- `from` åˆ—å‚æ•°ï¼š-1 ä»£è¡¨æ˜¯ä»ä¸Šä¸€å±‚è·å¾—çš„è¾“å…¥ï¼Œ-2 è¡¨ç¤ºä»ä¸Šä¸¤å±‚è·å¾—çš„è¾“å…¥ã€‚
- `number` åˆ—å‚æ•°ï¼š1 è¡¨ç¤ºåªæœ‰ä¸€ä¸ªï¼Œ3 è¡¨ç¤ºæœ‰ä¸‰ä¸ªç›¸åŒçš„æ¨¡å—ã€‚
- `module` è¡¨ç¤ºæ¨¡å—ï¼šåŒ…æ‹¬ SPPã€Convã€Bottleneckã€BottleneckCSPï¼Œä»£ç å¯ä»¥åœ¨`./models/common.py`ä¸­è·å–åˆ°ã€‚
- `[64, 3]` è§£æå¾—åˆ° `[3, 32, 3]` ï¼Œè¾“å…¥ä¸º`3`ï¼ˆRGBï¼‰ï¼Œè¾“å‡ºä¸º`32`ï¼Œå·ç§¯æ ¸ k ä¸º`3`ï¼›
- `[128, 3, 2]` è¿™æ˜¯å›ºå®šçš„ï¼Œ128 è¡¨ç¤ºè¾“å‡º 128 ä¸ªå·ç§¯æ ¸ä¸ªæ•°ã€‚æ ¹æ® [128, 3, 2] è§£æå¾—åˆ° `[32, 64, 3, 2]` ï¼Œ`32` æ˜¯è¾“å…¥ï¼Œ`64` æ˜¯è¾“å‡ºï¼ˆ128*0.5=64ï¼‰ï¼Œ`3` è¡¨ç¤º3Ã—3çš„å·ç§¯æ ¸ï¼Œ`2` è¡¨ç¤ºæ­¥é•¿ä¸º2ã€‚

args è¿™é‡Œçš„è¾“å…¥éƒ½çœå»äº†ï¼Œå› ä¸ºè¾“å…¥éƒ½æ˜¯ä¸Šå±‚çš„è¾“å‡ºã€‚ä¸ºäº†ä¿®æ”¹è¿‡äºéº»çƒ¦ï¼Œè¿™é‡Œè¾“å…¥çš„è·å–æ˜¯ä»`./models/yolo.py`çš„`def parse_model(md, ch)`å‡½æ•°ä¸­è§£æå¾—åˆ°çš„ã€‚

## 1.1. parameters

> https://www.cnblogs.com/E-Dreamer-Blogs/p/13297580.html

- **`nc`**ï¼šç±»åˆ«æ•°ã€‚

- **`depth_multiple`**ï¼šæ§åˆ¶**æ¨¡å‹çš„æ·±åº¦**ã€‚

  åœ¨ backbone ä¸­çš„ `number â‰  1` çš„æƒ…å†µä¸‹ç”Ÿæ•ˆã€‚
  - yolov5sä¸­ï¼š`depth_multiple = 0.33`ï¼Œ
  - yolov5mä¸­: `depth_multiple = 0.66`
  - yolov5lä¸­: `depth_multiple = 1`
  - yolov5xä¸­: `depth_multiple = 1.33`
  
  å‡è®¾ yolov5l ä¸­æœ‰ä¸‰ä¸ª BottleneckCSPï¼Œé‚£ yolov5s ä¸­å°±åªæœ‰ä¸€ä¸ª BottleneckCSPï¼Œé‚£
  `number = 1` è¡¨ç¤ºçš„æ˜¯åŠŸèƒ½èƒŒæ™¯çš„å±‚ï¼Œæ¯”å¦‚ Convã€Focusã€SPPã€‚

- **`width_multiple`**ï¼šæ§åˆ¶**å·ç§¯æ ¸çš„ä¸ªæ•°**ã€‚

  ç”¨äºè®¾ç½® argumentsï¼Œä¾‹å¦‚ yolov5s è®¾ç½®ä¸º 0.5ï¼Œåˆ™ Focus å°±å˜æˆ `[32, 3]`ï¼ŒConv å°±å˜æˆ `[64, 3, 2]`ã€‚ä»¥æ­¤ç±»æ¨ï¼Œå·ç§¯æ ¸çš„ä¸ªæ•°éƒ½å˜æˆäº†è®¾ç½®çš„ä¸€åŠã€‚

yolov5æä¾›äº† sã€mã€lã€x å››ç§å°ºå¯¸çš„ç½‘ç»œï¼Œæ‰€æœ‰çš„`.yaml`æ–‡ä»¶éƒ½ä¸€æ ·ï¼Œåªéœ€è¦ä¿®æ”¹è¿™ä¸¤ä¸ªå‚æ•°å°±å¯ä»¥è°ƒæ•´æ¨¡å‹çš„ç½‘ç»œç»“æ„ã€‚

## 1.2. backnone

https://blog.csdn.net/jiafeier_555/article/details/109052569

éª¨å¹²ç½‘ç»œç‰¹å¾å›¾ä»å¤§åˆ°å°ï¼Œæ·±åº¦åŠ æ·±ã€‚

### 1.2.1. Focus

ä¸€ç§ä¸‹é‡‡æ ·æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†åŸå›¾å°ºå¯¸å˜ä¸ºåŸæ¥çš„ä¸€åŠï¼Œå³æ­¥é•¿è®¾ä¸º2ï¼Œç„¶åå°†é€šé“å˜ä¸ºåŸæ¥çš„4å€ï¼Œè¿™æ ·ä¿¡æ¯æ²¡ä¸¢ï¼Œä½†æ˜¯å°ºåº¦å˜å°äº†ã€‚

ä»é«˜åˆ†è¾¨ç‡å›¾åƒä¸­ï¼Œå‘¨æœŸæ€§çš„æŠ½å‡ºåƒç´ ç‚¹é‡æ„åˆ°ä½åˆ†è¾¨ç‡å›¾åƒä¸­ï¼Œå³å°†å›¾åƒç›¸é‚»çš„å››ä¸ªä½ç½®è¿›è¡Œå †å ï¼Œèšç„¦ wh ç»´åº¦ä¿¡æ¯åˆ° c é€šé“ç©ºé—´ï¼Œæé«˜æ¯ä¸ªç‚¹æ„Ÿå—é‡ï¼Œå¹¶å‡å°‘åŸå§‹ä¿¡æ¯çš„ä¸¢å¤±ï¼Œè¯¥æ¨¡å—çš„è®¾è®¡ä¸»è¦æ˜¯å‡å°‘è®¡ç®—é‡åŠ å¿«é€Ÿåº¦ã€‚
ä½œè€…åŸè¯ï¼šFocus() module is designed for FLOPS reduction and speed increase, not mAP increase.

```python
class Focus(nn.Module):
    # Focus wh information into c-space
    def __init__(self, c1, c2, k=1, s=1, p=None, g=1, act=True):  # ch_in, ch_out, kernel, stride, padding, groups
        super(Focus, self).__init__()
        self.conv = Conv(c1 * 4, c2, k, s, p, g, act)

    def forward(self, x):  # x(b,c,w,h) -> y(b,4c,w/2,h/2)
        return self.conv(torch.cat([x[..., ::2, ::2], x[..., 1::2, ::2], x[..., ::2, 1::2], x[..., 1::2, 1::2]], 1))
```

### 1.2.2. Conv

```python
class Conv(nn.Module):
    # Standard convolution
    def __init__(self, c1, c2, k=1, s=1, p=None, g=1, act=True):  # ch_in, ch_out, kernel, stride, padding, groups
        super(Conv, self).__init__()
        self.conv = nn.Conv2d(c1, c2, k, s, autopad(k, p), groups=g, bias=False)
        self.bn = nn.BatchNorm2d(c2)
        self.act = nn.Hardswish() if act else nn.Identity()

    def forward(self, x):
        return self.act(self.bn(self.conv(x)))

    def fuseforward(self, x):
        return self.act(self.conv(x))
    
def autopad(k, p=None):  # kernel, padding
    # Pad to 'same'
    if p is None:
        p = k // 2 if isinstance(k, int) else [x // 2 for x in k]  # auto-pad
    return p

```
CONVå±‚ä½¿ç”¨çš„æ¿€æ´»å‡½æ•°æ˜¯ `Hardswish`;

atuopad æ˜¯è‡ªåŠ¨å¡« padding çš„å€¼ï¼Œåœ¨`k=1`çš„æ—¶å€™ï¼Œ`padding=0`ï¼Œåœ¨`k=3`çš„æ—¶å€™`padding=1`

### 1.2.3. BottleneckCSP

é¦–å…ˆä»‹ç» **bottleneck**ã€‚

```python
class Bottleneck(nn.Module):
    # Standard bottleneck
    def __init__(self, c1, c2, shortcut=True, g=1, e=0.5):  # ch_in, ch_out, shortcut, groups, expansion
        super(Bottleneck, self).__init__()
        c_ = int(c2 * e)  # hidden channels
        self.cv1 = Conv(c1, c_, 1, 1)
        self.cv2 = Conv(c_, c2, 3, 1, g=g)
        self.add = shortcut and c1 == c2

    def forward(self, x):
        return x + self.cv2(self.cv1(x)) if self.add else self.cv2(self.cv1(x))
```
å‚æ•°è¯´æ˜ï¼š

- `c1`ï¼šbottleneck ç»“æ„çš„è¾“å…¥é€šé“ç»´åº¦ï¼›
- `c2`ï¼šbottleneck ç»“æ„çš„è¾“å‡ºé€šé“ç»´åº¦ï¼›
- `shortcut`ï¼šæ˜¯å¦ç»™bottleneck ç»“æ„æ·»åŠ shortcutè¿æ¥ï¼Œæ·»åŠ åå³ä¸ºResNetæ¨¡å—ï¼›
- `g`ï¼šgroupsï¼Œé€šé“åˆ†ç»„çš„å‚æ•°ï¼Œè¾“å…¥é€šé“æ•°ã€è¾“å‡ºé€šé“æ•°å¿…é¡»åŒæ—¶æ»¡è¶³è¢«groupsæ•´é™¤ï¼›
- `e`ï¼šexpansion: bottleneck ç»“æ„ä¸­çš„ç“¶é¢ˆéƒ¨åˆ†çš„é€šé“è†¨èƒ€ç‡ï¼Œä½¿ç”¨0.5å³ä¸ºå˜ä¸ºè¾“å…¥çš„1/2ï¼›

![](.//../assets/img/postsimg/20210616/bottleneck.jpg)

ç“¶é¢ˆå±‚çš„ç“¶é¢ˆä¸»è¦ä½“ç°åœ¨é€šé“æ•°ä¸Šé¢ã€‚ä¸€èˆ¬ `1 x 1` å·ç§¯å…·æœ‰å¾ˆå¼ºçš„çµæ´»æ€§ï¼Œè¿™é‡Œç”¨äºé™ä½é€šé“æ•°ï¼Œå¦‚è†¨èƒ€ç‡ä¸º  `0.5`ï¼Œè‹¥è¾“å…¥é€šé“ä¸º `640`ï¼Œé‚£ä¹ˆç»è¿‡`1 x 1` çš„å·ç§¯å±‚ä¹‹åå˜ä¸º `320`ï¼›ç»è¿‡ `3x3` ä¹‹åå˜ä¸ºè¾“å‡ºçš„é€šé“æ•°ï¼Œè¿™æ ·å‚æ•°é‡ä¼šå¤§é‡å‡å°‘ã€‚

ç„¶åä»‹ç» **CSP Bottleneck**ã€‚

> CSP Bottleneck: https://github.com/WongKinYiu/CrossStagePartialNetworks

```python
class BottleneckCSP(nn.Module):
    # CSP Bottleneck https://github.com/WongKinYiu/CrossStagePartialNetworks
    def __init__(self, c1, c2, n=1, shortcut=True, g=1, e=0.5):  # ch_in, ch_out, number, shortcut, groups, expansion
        super(BottleneckCSP, self).__init__()
        c_ = int(c2 * e)  # hidden channels
        self.cv1 = Conv(c1, c_, 1, 1)
        self.cv2 = nn.Conv2d(c1, c_, 1, 1, bias=False)
        self.cv3 = nn.Conv2d(c_, c_, 1, 1, bias=False)
        self.cv4 = Conv(2 * c_, c2, 1, 1)
        self.bn = nn.BatchNorm2d(2 * c_)  # applied to cat(cv2, cv3)
        self.act = nn.LeakyReLU(0.1, inplace=True)
        self.m = nn.Sequential(*[Bottleneck(c_, c_, shortcut, g, e=1.0) for _ in range(n)])

    def forward(self, x):
        y1 = self.cv3(self.m(self.cv1(x)))
        y2 = self.cv2(x)
        return self.cv4(self.act(self.bn(torch.cat((y1, y2), dim=1))))
```

Cross Stage Partial Network (CSPNet)å°±æ˜¯ä»ç½‘ç»œç»“æ„è®¾è®¡çš„è§’åº¦æ¥è§£å†³ä»¥å¾€å·¥ä½œåœ¨æ¨ç†è¿‡ç¨‹ä¸­éœ€è¦å¾ˆå¤§è®¡ç®—é‡çš„é—®é¢˜ã€‚

![](../assets/img/postsimg/20210616/cspnet.jpg)

å…ˆç”¨ä¸€å±‚ç½‘ç»œï¼ˆCV1,CV2ï¼‰å°†é€šé“é™ä¸ºåŸæ¥çš„ä¸€åŠï¼ˆè¯è¯´è¿™ä¸ªçœŸçš„æ˜¯CSPå—ï¼ŸğŸ¤”ï¼‰,ç„¶ååˆ†ä¸ºä¸¤ä¸ªè·¯å¾„ï¼Œä¸€ä¸ªè·¯å¾„è¿›è¡Œç‰¹å¾æå–ï¼Œå¦ä¸€ä¸ªä¸è¿›è¡Œï¼ˆCSPçš„æ“ä½œï¼‰ï¼Œæœ€åå°†ä¸¤ä¸ªè·¯å¾„concatèµ·æ¥ã€‚

å€˜è‹¥è¯¥å±‚åé¢æœ‰BNå±‚çš„è¯ï¼Œä¸€èˆ¬é€‰æ‹©`bias=False`ï¼ˆå› ä¸ºBNåŒ…å«åç½®ï¼‰ï¼Œè€Œåé¢æ²¡æœ‰çš„æ—¶å€™`bias=True`ã€‚ä¸Šé¢çš„ Conv å±‚å’Œ CSPNet ä¹Ÿæ˜¯è¿™ä¸ªè§„å¾‹

## 1.3. head

YOLO V5 ä½¿ç”¨çš„ head æ˜¯ PANetã€‚

> PANet: https://arxiv.org/pdf/1803.01534.pdf

# 2. è®­ç»ƒ

## 2.1. å‡†å¤‡æ ‡ç­¾

yoloæ ¼å¼çš„æ ‡ç­¾ä¸ºtxtæ ¼å¼çš„æ–‡ä»¶ï¼Œæ–‡ä»¶åè·Ÿå¯¹åº”çš„å›¾ç‰‡åä¸€æ ·ï¼Œé™¤äº†åç¼€æ”¹ä¸ºäº†.txtã€‚ å…·ä½“æ ¼å¼å¦‚ä¸‹ï¼š

- æ¯ä¸ªç›®æ ‡ä¸€è¡Œï¼Œæ•´ä¸ªå›¾ç‰‡æ²¡æœ‰ç›®æ ‡çš„è¯ä¸éœ€è¦æœ‰txtæ–‡ä»¶
- æ¯è¡Œçš„æ ¼å¼ä¸º`class_num x_center y_center width height`
- å…¶ä¸­`class_num`å–å€¼ä¸º`0`è‡³`total_class - 1`ï¼Œæ¡†çš„å››ä¸ªå€¼`x_center y_center width height`æ˜¯ç›¸å¯¹äºå›¾ç‰‡åˆ†è¾¨ç‡å¤§å°æ­£åˆ™åŒ–çš„`0-1`ä¹‹é—´çš„æ•°ï¼Œå·¦ä¸Šè§’ä¸º`(0,0)`ï¼Œå³ä¸‹è§’ä¸º`(1,1)`
- 
<img width="500" src="https://user-images.githubusercontent.com/26833433/91506361-c7965000-e886-11ea-8291-c72b98c25eec.jpg">  

## 2.2. æ•°æ®å­˜æ”¾ä½ç½®

yolov5çš„ä»£ç ä¼šæ ¹æ®å›¾ç‰‡æ‰¾æ ‡ç­¾ï¼Œå…·ä½“å½¢å¼çš„æŠŠå›¾ç‰‡è·¯å¾„`/images/*.jpg`æ›¿æ¢ä¸º`/labels/*.txt`ï¼Œæ‰€ä»¥è¦æ–°å»ºä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸€ä¸ªåä¸º`images`å­˜æ”¾å›¾ç‰‡ï¼Œä¸€ä¸ªåä¸º`labels`å­˜æ”¾æ ‡ç­¾txtæ–‡ä»¶ï¼Œå¦‚åˆ†è®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†çš„è¯ï¼Œè¿˜è¦å†æ–°å»ºå„è‡ªçš„æ–‡ä»¶å¤¹ï¼Œå¦‚ï¼š

```
coco
|--images
   |--train2017
   |--val2017
|--labels
   |--train2017
   |--val2017
```

## 2.3. å‡†å¤‡æ¨¡å‹

è‡ªå®šä¹‰è®­ç»ƒéœ€è¦ä¿®æ”¹.yamlæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯æ¨¡å‹æ–‡ä»¶(å¯é€‰)ï¼Œä¸€ä¸ªæ˜¯æ•°æ®æ–‡ä»¶ã€‚

- æ¨¡å‹æ–‡ä»¶(å¯é€‰):å¯ä»¥æ ¹æ®ä½ é€‰æ‹©è®­ç»ƒçš„æ¨¡å‹ï¼Œç›´æ¥ä¿®æ”¹`./models`é‡Œçš„`yolov5s.yaml / yolov5m.yaml / yolov5l.yaml / yolov5x.yaml`æ–‡ä»¶ï¼Œåªéœ€è¦å°†nc: 80ä¸­çš„80ä¿®æ”¹ä¸ºä½ æ•°æ®é›†çš„ç±»åˆ«æ•°ã€‚å…¶ä»–ä¸ºæ¨¡å‹ç»“æ„ä¸éœ€è¦æ”¹ã€‚ æ³¨æ„ :å½“éœ€è¦éšæœºåˆå§‹åŒ–æ—¶æ‰ä¼šä½¿ç”¨æœ¬æ–‡ä»¶ï¼Œå®˜æ–¹æ¨èä½¿ç”¨é¢„è®­ç»ƒæƒé‡åˆå§‹åŒ–ã€‚
- æ•°æ®æ–‡ä»¶:æ ¹æ®`./data`æ–‡ä»¶å¤¹é‡Œçš„cocoæ•°æ®æ–‡ä»¶ï¼Œåˆ¶ä½œè‡ªå·±çš„æ•°æ®æ–‡ä»¶ï¼Œåœ¨æ•°æ®æ–‡ä»¶ä¸­å®šä¹‰è®­ç»ƒé›†ã€éªŒè¯é›†ã€æµ‹è¯•é›†è·¯å¾„ï¼›å®šä¹‰æ€»ç±»åˆ«æ•°ï¼›å®šä¹‰ç±»åˆ«åç§°

``` python
# train and val data as 1) directory: path/images/, 2) file: path/images.txt, or 3) list: [path1/images/, path2/images/]
train: ../coco128/images/train2017/
val: ../coco128/images/val2017/
test:../coco128/images/test2017/

# number of classes
nc: 80

# class names
names: ['person', 'bicycle', 'car', 'motorcycle', 'airplane', 'bus', 'train', 'truck', 'boat', 'traffic light',
        'fire hydrant', 'stop sign', 'parking meter', 'bench', 'bird', 'cat', 'dog', 'horse', 'sheep', 'cow',
        'elephant', 'bear', 'zebra', 'giraffe', 'backpack', 'umbrella', 'handbag', 'tie', 'suitcase', 'frisbee',
        'skis', 'snowboard', 'sports ball', 'kite', 'baseball bat', 'baseball glove', 'skateboard', 'surfboard',
        'tennis racket', 'bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon', 'bowl', 'banana', 'apple',
        'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza', 'donut', 'cake', 'chair', 'couch',
        'potted plant', 'bed', 'dining table', 'toilet', 'tv', 'laptop', 'mouse', 'remote', 'keyboard', 
        'cell phone', 'microwave', 'oven', 'toaster', 'sink', 'refrigerator', 'book', 'clock', 'vase', 'scissors', 
        'teddy bear', 'hair drier', 'toothbrush']
```

## 2.4. è¿›è¡Œè®­ç»ƒ

è®­ç»ƒç›´æ¥è¿è¡Œtrain.pyå³å¯ï¼Œåé¢æ ¹æ®éœ€è¦åŠ ä¸ŠæŒ‡ä»¤å‚æ•°ï¼Œ--weightsæŒ‡å®šæƒé‡ï¼Œ--dataæŒ‡å®šæ•°æ®æ–‡ä»¶ï¼Œ--batch-sizeæŒ‡å®šbatchå¤§å°ï¼Œ--epochsæŒ‡å®šepochã€‚ä¸€ä¸ªç®€å•çš„è®­ç»ƒè¯­å¥ï¼š

```python
# ä½¿ç”¨yolov5sæ¨¡å‹è®­ç»ƒcoco128æ•°æ®é›†5ä¸ªepochsï¼Œbatch sizeè®¾ä¸º16
python train.py --batch 16 --epochs 5 --data ./data/coco128.yaml --weights ./weights/yolov5s.pt
```
è®­ç»ƒæŒ‡ä»¤è¯´æ˜:

æœ‰å‚ï¼š

- `--weights` (â­)æŒ‡å®šæƒé‡ï¼Œå¦‚æœä¸åŠ æ­¤å‚æ•°ä¼šé»˜è®¤ä½¿ç”¨COCOé¢„è®­çš„`yolov5s.pt`ï¼Œ`--weights ''`åˆ™ä¼šéšæœºåˆå§‹åŒ–æƒé‡
- `--cfg` æŒ‡å®šæ¨¡å‹æ–‡ä»¶
- `--data` (â­)æŒ‡å®šæ•°æ®æ–‡ä»¶
- `--hyp`æŒ‡å®šè¶…å‚æ•°æ–‡ä»¶
- `--epochs` (â­)æŒ‡å®šepochæ•°ï¼Œé»˜è®¤300
- `--batch-size` (â­)æŒ‡å®šbatchå¤§å°ï¼Œé»˜è®¤16ï¼Œå®˜æ–¹æ¨èè¶Šå¤§è¶Šå¥½ï¼Œç”¨ä½ GPUèƒ½æ‰¿å—æœ€å¤§çš„batch sizeï¼Œå¯ç®€å†™ä¸º--batch
- `--img-size` æŒ‡å®šè®­ç»ƒå›¾ç‰‡å¤§å°ï¼Œé»˜è®¤640ï¼Œå¯ç®€å†™ä¸º--img
- `--name` æŒ‡å®šç»“æœæ–‡ä»¶åï¼Œé»˜è®¤result.txt
- `--device` æŒ‡å®šè®­ç»ƒè®¾å¤‡ï¼Œå¦‚--device 0,1,2,3
- `--local_rank` åˆ†å¸ƒå¼è®­ç»ƒå‚æ•°ï¼Œä¸è¦è‡ªå·±ä¿®æ”¹ï¼
- `--log-imgs` W&Bçš„å›¾ç‰‡æ•°é‡ï¼Œé»˜è®¤16ï¼Œæœ€å¤§100
- `--workers` æŒ‡å®šdataloaderçš„workersæ•°é‡ï¼Œé»˜è®¤8
- `--project` è®­ç»ƒç»“æœå­˜æ”¾ç›®å½•ï¼Œé»˜è®¤./runs/train/
- `--name` è®­ç»ƒç»“æœå­˜æ”¾åï¼Œé»˜è®¤exp
æ— å‚ï¼š

- `--rect`çŸ©å½¢è®­ç»ƒ
- `--resume` ç»§ç»­è®­ç»ƒï¼Œé»˜è®¤ä»æœ€åä¸€æ¬¡è®­ç»ƒç»§ç»­
- `--nosave` è®­ç»ƒä¸­é€”ä¸å­˜å‚¨æ¨¡å‹ï¼Œåªå­˜æœ€åä¸€ä¸ªcheckpoint
- `--notest` è®­ç»ƒä¸­é€”ä¸åœ¨éªŒè¯é›†ä¸Šæµ‹è¯•ï¼Œè®­ç»ƒå®Œæ¯•å†æµ‹è¯•
- `--noautoanchor` å…³é—­è‡ªåŠ¨é”šç‚¹æ£€æµ‹
- `--evolve`è¶…å‚æ•°æ¼”å˜
- `--bucket`ä½¿ç”¨gsutil bucket
- `--cache-images` ä½¿ç”¨ç¼“å­˜å›¾ç‰‡è®­ç»ƒ
- `--image-weights` è®­ç»ƒä¸­å¯¹å›¾ç‰‡åŠ æƒé‡
- `--multi-scale` è®­ç»ƒå›¾ç‰‡å¤§å°+/-50%å˜æ¢
- `--single-cls` å•ç±»è®­ç»ƒ
- `--adam` ä½¿ç”¨torch.optim.Adam()ä¼˜åŒ–å™¨
- `--sync-bn` ä½¿ç”¨SyncBatchNormï¼Œåªåœ¨åˆ†å¸ƒå¼è®­ç»ƒå¯ç”¨
- `--log-artifacts` è¾“å‡ºartifacts,å³æ¨¡å‹æ•ˆæœ
- `--exist-ok` å¦‚è®­ç»ƒç»“æœå­˜æ”¾è·¯å¾„é‡åï¼Œä¸è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶å¤¹
- `--quad` ä½¿ç”¨å››åˆ†dataloader

# 3. æµ‹è¯•

é¦–å…ˆæ˜ç¡®ï¼Œæ¨ç†æ˜¯ç›´æ¥æ£€æµ‹å›¾ç‰‡ï¼Œè€Œæµ‹è¯•æ˜¯éœ€è¦å›¾ç‰‡æœ‰ç›¸åº”çš„çœŸå®æ ‡ç­¾çš„ï¼Œç›¸å½“äºæ£€æµ‹å›¾ç‰‡åå†æŠŠæ¨ç†æ ‡ç­¾å’ŒçœŸå®æ ‡ç­¾åšmAPè®¡ç®—ã€‚

ä½¿ç”¨`./weights/yolov5x.pt`æƒé‡æ£€æµ‹`./data/coco.yaml`é‡Œå®šä¹‰çš„æµ‹è¯•é›†ï¼Œå›¾ç‰‡åˆ†è¾¨ç‡è®¾ä¸º672ã€‚

```python
python test.py --weights ./weights/yolov5x.pt --data ./data/coco.yaml --img 672
```

æœ‰å‚ï¼š

- `--weights`(â­) æµ‹è¯•æ‰€ç”¨æƒé‡ï¼Œé»˜è®¤yolov5sCOCOé¢„è®­ç»ƒæƒé‡æ¨¡å‹
- `--data`(â­) æµ‹è¯•æ‰€ç”¨çš„.yamlæ–‡ä»¶ï¼Œé»˜è®¤ä½¿ç”¨./data/coco128.yaml
- `--batch-size` æµ‹è¯•ç”¨çš„batchå¤§å°ï¼Œé»˜è®¤32ï¼Œè¿™ä¸ªå¤§å°å¯¹ç»“æœæ— å½±å“
- `--img-size` æµ‹è¯•é›†åˆ†è¾¨ç‡å¤§å°ï¼Œé»˜è®¤640ï¼Œæµ‹è¯•å»ºè®®ä½¿ç”¨æ›´é«˜åˆ†è¾¨ç‡
- `--conf-thres`ç›®æ ‡ç½®ä¿¡åº¦é˜ˆå€¼ï¼Œé»˜è®¤0.001
- `--iou-thres`NMSçš„IOUé˜ˆå€¼ï¼Œé»˜è®¤0.65
- `--task` æŒ‡å®šä»»åŠ¡æ¨¡å¼ï¼Œtrain, val, æˆ–è€…test,æµ‹è¯•çš„è¯ç”¨--task test
- `--device` æŒ‡å®šè®¾å¤‡ï¼Œå¦‚--device 0 --device 0,1,2,3 --device cpu
- `--project` æŒ‡å®šç»“æœå­˜æ”¾è·¯å¾„ï¼Œé»˜è®¤./runs/test/
- `--name` æŒ‡å®šç»“æœå­˜æ”¾å,é»˜è®¤`exp`

æ— å‚ï¼š

- `--single-cls` è§†ä¸ºåªæœ‰ä¸€ç±»
- `--augment` å¢å¼ºè¯†åˆ«
- `--verbose` è¾“å‡ºå„ä¸ªç±»åˆ«çš„mAP
- `--save-txt` è¾“å‡ºæ ‡ç­¾ç»“æœ(yoloæ ¼å¼)
- `--save-hybrid` è¾“å‡ºæ ‡ç­¾+é¢„æµ‹æ··åˆç»“æœåˆ°txt
- `--save-conf` ä¿å­˜ç½®ä¿¡åº¦è‡³è¾“å‡ºæ–‡ä»¶ä¸­
- `--save-json` ä¿å­˜ç»“æœä¸ºjson
- `--exist-ok` è‹¥é‡åä¸è¦†ç›–
```

# æ£€æµ‹

## å¿«é€Ÿæ£€æµ‹

ç›´æ¥æ‰§è¡Œ`detect.py`ï¼ŒæŒ‡å®šä¸€ä¸‹è¦æ¨ç†çš„ç›®å½•å³å¯ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šæƒé‡ï¼Œä¼šè‡ªåŠ¨ä¸‹è½½é»˜è®¤COCOé¢„è®­ç»ƒæƒé‡æ¨¡å‹ã€‚æ¨ç†ç»“æœé»˜è®¤ä¼šä¿å­˜åˆ°`./runs/detect`ä¸­ã€‚
æ³¨æ„ï¼šæ¯æ¬¡æ¨ç†ä¼šæ¸…ç©ºoutputæ–‡ä»¶å¤¹ï¼Œæ³¨æ„ç•™å­˜æ¨ç†ç»“æœã€‚

â€‹```python
# å¿«é€Ÿæ¨ç†ï¼Œ--source æŒ‡å®šæ£€æµ‹æºï¼Œä»¥ä¸‹ä»»æ„ä¸€ç§ç±»å‹éƒ½æ”¯æŒï¼š
python detect.py --source 0  # æœ¬æœºé»˜è®¤æ‘„åƒå¤´
                          file.jpg  # å›¾ç‰‡ 
                          file.mp4  # è§†é¢‘
                          path/  # æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰åª’ä½“
                          path/*.jpg  # æ–‡ä»¶å¤¹ä¸‹æŸç±»å‹åª’ä½“
```

## 3.1. è‡ªå®šä¹‰æ£€æµ‹

ä½¿ç”¨æƒé‡`./weights/yolov5s.pt`å»æ¨ç†`./data/images`æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰åª’ä½“ï¼Œå¹¶ä¸”æ¨ç†ç½®ä¿¡åº¦é˜ˆå€¼è®¾ä¸º0.5:

```python
python detect.py --source ./data/images/ --weights ./weights/yolov5s.pt --conf 0.5
```

## 3.2. æ£€æµ‹å‚æ•°

è‡ªå·±æ ¹æ®éœ€è¦åŠ å„ç§æŒ‡ä»¤ã€‚

æœ‰å‚ï¼š

- `--source`(â­) æŒ‡å®šæ£€æµ‹æ¥æº
- `--weights` æŒ‡å®šæƒé‡ï¼Œä¸æŒ‡å®šçš„è¯ä¼šä½¿ç”¨yolov5s.pté¢„è®­ç»ƒæƒé‡
- `--img-size` æŒ‡å®šæ¨ç†å›¾ç‰‡åˆ†è¾¨ç‡ï¼Œé»˜è®¤640ï¼Œä¹Ÿå¯ä½¿ç”¨--img
- `--conf-thres` æŒ‡å®šç½®ä¿¡åº¦é˜ˆå€¼ï¼Œé»˜è®¤0.4ï¼Œä¹Ÿå¯ä½¿ç”¨--conf
- `--iou-thres` æŒ‡å®šNMS(éæå¤§å€¼æŠ‘åˆ¶)çš„IOUé˜ˆå€¼ï¼Œé»˜è®¤0.5
- `--device` æŒ‡å®šè®¾å¤‡ï¼Œå¦‚`--device 0` `--device 0,1,2,3` `--device cpu`
- `--classes` åªæ£€æµ‹ç‰¹å®šçš„ç±»ï¼Œå¦‚`--classes 0 2 4 6 8`
- `--project` æŒ‡å®šç»“æœå­˜æ”¾è·¯å¾„ï¼Œé»˜è®¤`./runs/detect/`
- `--name` æŒ‡å®šç»“æœå­˜æ”¾å,é»˜è®¤`exp`

æ— å‚ï¼š

- `--view-img` å›¾ç‰‡å½¢å¼æ˜¾ç¤ºç»“æœ
- `--save-txt` è¾“å‡ºæ ‡ç­¾ç»“æœ(yoloæ ¼å¼)
- `--save-conf` åœ¨è¾“å‡ºæ ‡ç­¾ç»“æœtxtä¸­åŒæ ·å†™å…¥æ¯ä¸ªç›®æ ‡çš„ç½®ä¿¡åº¦
- `--agnostic-nms` ä½¿ç”¨agnostic NMS(å‰èƒŒæ™¯)
- `--augment` å¢å¼ºè¯†åˆ«ï¼Œé€Ÿåº¦ä¼šæ…¢ä¸å°‘ã€‚è¯¦æƒ…
- `--update` æ›´æ–°æ‰€æœ‰æ¨¡å‹
- `--exist-ok` è‹¥é‡åä¸è¦†ç›–

# å…¶å®ƒ

BFLOPS çš„æ¦‚å¿µï¼šhttps://blog.csdn.net/weixin_38145317/article/details/106281462

## 3.3. Citation

[![DOI](https://zenodo.org/badge/264818686.svg)](https://zenodo.org/badge/latestdoi/264818686)

